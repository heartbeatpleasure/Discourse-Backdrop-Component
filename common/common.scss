@use "sass:math";

/*
  Side Backdrop (Margin) - Theme Component
  Adds decorative panels left/right of the main Discourse layout when there is enough horizontal space.
*/

$tc-pattern-image: none;

// Pattern preset -> image mapping
@if $backdrop-preset == "red_hearts" {
  $tc-pattern-image: url($tc-backdrop-red-hearts);
} @else if $backdrop-preset == "halloween" {
  $tc-pattern-image: url($tc-backdrop-halloween);
} @else if $backdrop-preset == "christmas" {
  $tc-pattern-image: url($tc-backdrop-christmas);
} @else if $backdrop-preset == "new_year" {
  $tc-pattern-image: url($tc-backdrop-new-year);
} @else if $backdrop-preset == "easter" {
  $tc-pattern-image: url($tc-backdrop-easter);
} @else {
  $tc-pattern-image: none;
}

$tc-left-image: none;
$tc-right-image: none;

// Decide which images to use based on the selected mode
@if $image-mode == "pattern" {
  $tc-left-image: $tc-pattern-image;
  $tc-right-image: $tc-pattern-image;
} @else if $image-mode == "full" {
  @if $custom-backdrop-image != "" {
    $tc-left-image: url($custom-backdrop-image);
    $tc-right-image: url($custom-backdrop-image);
  } @else {
    $tc-left-image: none;
    $tc-right-image: none;
  }
} @else if $image-mode == "split" {
  // If only one side is provided, fall back to the other side so you never end up with "one blank side" by accident.
  @if $custom-backdrop-image-left != "" {
    $tc-left-image: url($custom-backdrop-image-left);
  } @else if $custom-backdrop-image-right != "" {
    $tc-left-image: url($custom-backdrop-image-right);
  } @else {
    $tc-left-image: none;
  }

  @if $custom-backdrop-image-right != "" {
    $tc-right-image: url($custom-backdrop-image-right);
  } @else if $custom-backdrop-image-left != "" {
    $tc-right-image: url($custom-backdrop-image-left);
  } @else {
    $tc-right-image: none;
  }
} @else {
  $tc-left-image: none;
  $tc-right-image: none;
}

:root {
  --tc-backdrop-image-left: #{$tc-left-image};
  --tc-backdrop-image-right: #{$tc-right-image};

  --tc-backdrop-opacity: #{math.div($opacity, 100)};
  --tc-backdrop-repeat: #{$repeat};
  --tc-backdrop-size: #{$size};
  --tc-backdrop-position-y: #{$position-y};

  --tc-backdrop-min-side-space: #{$min-side-space}px;
  --tc-backdrop-max-side-width: #{$max-side-width}px;
  --tc-backdrop-min-vw: #{$min-viewport-width}px;

  // Gap between the site edge and the artwork inside the panel.
  --tc-backdrop-gap-left: #{$gap-from-site-left}px;
  --tc-backdrop-gap-right: #{$gap-from-site-right}px;

  // Fallback widths based on Discourse's --d-max-width (default ~1110px).
  // JS will override widths with accurate values using #main-outlet-wrapper.
  --tc-backdrop-left-width: min(
    var(--tc-backdrop-max-side-width),
    max(0px, calc((100vw - var(--d-max-width)) / 2))
  );
  --tc-backdrop-right-width: var(--tc-backdrop-left-width);
}

.tc-backdrop {
  display: none;
  position: fixed;
  top: 0;
  bottom: 0;
  pointer-events: none;

  background-repeat: var(--tc-backdrop-repeat);
  background-size: var(--tc-backdrop-size);
  opacity: var(--tc-backdrop-opacity);

  // Keep it behind most UI without relying on negative z-index.
  z-index: 0;
}

// Align artwork to the site edge (removes the "white strip" feeling).
.tc-backdrop--left {
  left: 0;
  width: var(--tc-backdrop-left-width);
  background-image: var(--tc-backdrop-image-left);
  background-position: right var(--tc-backdrop-gap-left) var(--tc-backdrop-position-y);
}

.tc-backdrop--right {
  right: 0;
  width: var(--tc-backdrop-right-width);
  background-image: var(--tc-backdrop-image-right);
  background-position: left var(--tc-backdrop-gap-right) var(--tc-backdrop-position-y);
}

@if $mirror-right {
  .tc-backdrop--right {
    transform: scaleX(-1);
    transform-origin: center;
  }
}

@media (min-width: #{$min-viewport-width}px) {
  html.tc-backdrop-enabled .tc-backdrop {
    display: block;
  }
}
